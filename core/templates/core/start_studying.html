{% extends 'core/base.html' %}
{% load static %}

{% block title %}เริ่มเรียน: {{ session.subject.name }}{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" type="text/css" href="{% static 'core/start_studying.css' %}">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
{% endblock %}

{% block content %}
<nav class="navbar">
    <!-- Logo Section -->
    <div class="nav-left">
        <img class="logo-icon" src="{% static 'images/logo.png' %}" alt="Logo">
        <span>Smart Study Planner</span>
    </div>
    <!-- Profile Section -->
    <div class="profile-container" onclick="togglePopup()">
        <div class="profile-img">
            {% if user.profile_picture %}
                <img src="{{ user.profile_picture.url }}" class="profile-img-nav" alt="Profile">
            {% else %}
                <div class="profile-img-inner">
                    {{ user.username|make_list|first|upper }}
                </div>
            {% endif %}
        </div>
        <span style="font-weight: bold;">{{ user.username }}</span>
        <div id="profile-popup" class="profile-popup">
            <!-- <ul class="popup-menu">
                <li><a href="#">แก้ไขโปรไฟล์</a></li>
                <li><a href="#">ความคืบหน้า</a></li>
                <li><a href="#">สร้างแผนใหม่</a></li>
                <li><a href="#">การแจ้งเตือน</a></li>
                <li>
                    <form action="{% url 'logout' %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="btn-logout">ออกจากระบบ</button>
                    </form>
                </li>
            </ul> -->
        </div>
    </div>
</nav>

<div class="study-container">
    <div class="study-header">
        <h1>{{ session.subject.name }}</h1>
        <p style="color: #666; margin-top: 5px;">{{ session.topic|default:"ไม่มีหัวข้อระบุ" }}</p>
    </div>

    <div class="study-grid">
        <div class="info-column">
            
            <div class="info-row">
                <div class="info-group">
                    <label>ระยะเวลาการอ่าน</label>
                    <div class="info-box">{{ duration_minutes }} นาที</div>
                </div>
                <div class="info-group">
                    <label>เวลา</label>
                    <div class="info-box">{{ session.start_time|date:"H:i" }} - {{ session.end_time|date:"H:i" }}</div>
                </div>
            </div>

            <div class="info-row">
                <div class="info-group">
                    <label>ระยะเวลาพักผ่อน</label>
                    <div class="info-box">
                        {% if break_minutes > 0 %}{{ break_minutes }} นาที{% else %}ไม่พัก{% endif %}
                    </div>
                </div>
                <div class="info-group">
                    <label>ความคืบหน้า</label>
                    <div class="info-box">{{ subject_progress }}%</div>
                </div>
            </div>

            <div class="info-group">
                <label>ระดับ</label>
                <div class="info-box">
                    {{ session.subject.get_difficulty_display }}
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <div class="timer-column">
            <div class="timer-wrapper">
                <svg class="timer-svg" viewBox="0 0 300 300">
                    <circle class="timer-circle-bg" cx="150" cy="150" r="140"></circle>
                    <circle id="timer-ring" class="timer-circle-progress" cx="150" cy="150" r="140"></circle>
                </svg>
                <div class="timer-text" id="timer-display">00:00:00</div>
            </div>
        </div>
    </div>

    <div class="action-buttons">
        <button id="btn-toggle" class="btn-action btn-start" onclick="toggleTimer()">เริ่มอ่าน</button>
        
        <button id="btn-skip" type="button" class="btn-action btn-skip" onclick="skipTimer()">
            <i class="fas fa-forward"></i> ข้าม (Test)
        </button>

        <a href="{% url 'home_page' %}" class="btn-action btn-back">กลับ</a>
        
        <a href="{% url 'complete_session' session.session_id %}" id="btn-finish" class="btn-action" style="background-color: #2ECC71; color: white; display: none;">
            เสร็จสิ้นการอ่าน
        </a>
        
    </div>
</div>

<div id="timeoutModal" class="modal-overlay" onclick="closeTimeoutModal(event)">
    <div class="modal-content-timeout">
        <div class="timeout-icon">
            <i class="fas fa-bell fa-shake"></i>
        </div>
        <h3>ถีงเวลาพักแล้วนะคนเก่ง</h3>
        <p>เก่งมาก! อย่าลืมพักผ่อนสายตาสักนิดนะ</p>
    </div>
</div>

<div id="confirmSkipModal" class="modal-confirm-overlay" onclick="closeConfirmModal(event)">
    <div class="modal-content-confirm">
        <div class="confirm-icon">
            <i class="fas fa-question"></i>
        </div>
        <h3>ยืนยันการข้าม?</h3>
        <p>คุณต้องการข้ามการจับเวลาและจบ Session นี้ทันทีใช่หรือไม่?</p>
        <div class="confirm-actions">
            <button class="btn-confirm-cancel" onclick="closeConfirmModal()">ยกเลิก</button>
            <button class="btn-confirm-yes" onclick="confirmSkip()">ยืนยัน</button>
        </div>
    </div>
</div>

<script>
    // Configuration
    const durationMinutes = {{ duration_minutes }};
    let timeRemaining = durationMinutes * 60; // seconds
    let totalTime = timeRemaining;
    let isRunning = false;
    let timerInterval = null;

    // DOM Elements
    const timerDisplay = document.getElementById('timer-display');
    const timerRing = document.getElementById('timer-ring');
    const btnToggle = document.getElementById('btn-toggle');
    const btnFinish = document.getElementById('btn-finish');
    
    // Circle Props for Animation
    const radius = 140;
    const circumference = 2 * Math.PI * radius;
    timerRing.style.strokeDasharray = `${circumference} ${circumference}`;
    timerRing.style.strokeDashoffset = 0;

    // Format Time HH:MM:SS
    function formatTime(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = seconds % 60;
        // แสดง HH:MM:SS หรือ MM:SS ถ้าชั่วโมงเป็น 0 ตามความเหมาะสม
        // ตามภาพต้นแบบมี HH ดังนั้นแสดงครบเลย
        return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    // Set initial Display
    timerDisplay.textContent = formatTime(timeRemaining);

    function setProgress(percent) {
        const offset = circumference - (percent / 100) * circumference;
        timerRing.style.strokeDashoffset = offset;
    }

    function toggleTimer() {
        if (isRunning) {
            // Pause
            pauseTimer();
        } else {
            // Start
            startTimer();
        }
    }

    function startTimer() {
        isRunning = true;
        btnToggle.textContent = "หยุดชั่วคราว";
        btnToggle.classList.add('running');
        
        timerInterval = setInterval(() => {
            if (timeRemaining > 0) {
                timeRemaining--;
                timerDisplay.textContent = formatTime(timeRemaining);
                
                // Update Circle
                const percentRemaining = (timeRemaining / totalTime) * 100;
                // Inverse for countdown visual (full to empty)
                setProgress(percentRemaining);
            } else {
                finishTimer();
            }
        }, 1000);
    }

    function pauseTimer() {
        isRunning = false;
        btnToggle.textContent = "เรียนต่อ";
        btnToggle.classList.remove('running');
        clearInterval(timerInterval);
    }

    function skipTimer() {
        const modal = document.getElementById('confirmSkipModal');
        modal.style.display = 'flex';
    }

    // ✅ 2. ฟังก์ชันกด "ยืนยัน" ใน Popup
    function confirmSkip() {
        // ปิด Popup ยืนยันก่อน
        document.getElementById('confirmSkipModal').style.display = 'none';
        
        // สั่งจบเวลา
        timeRemaining = 0; 
        finishTimer();
    }

    // ✅ 3. ฟังก์ชันปิด Popup (ยกเลิก)
    function closeConfirmModal(event) {
        const modal = document.getElementById('confirmSkipModal');
        // ถ้าไม่ส่ง event มา (กดปุ่ม) หรือ กดโดนพื้นหลัง (Overlay)
        if (!event || event.target === modal) {
            modal.style.display = 'none';
        }
    }

    function finishTimer() {
        clearInterval(timerInterval);
        isRunning = false;
        
        // อัปเดตหน้าจอเป็น 00:00:00
        timerDisplay.textContent = "00:00:00";
        timerRing.style.strokeDashoffset = circumference; 
        
        // จัดการปุ่ม
        btnToggle.style.display = 'none'; 
        document.getElementById('btn-skip').style.display = 'none'; // ซ่อนปุ่มข้ามด้วย
        btnFinish.style.display = 'block'; 
        
        // ✅ แสดง Popup แจ้งเตือนสวยๆ แทน Alert เดิม
        showTimeoutPopup();
        
        // เล่นเสียง (ถ้าต้องการ)
        // const audio = new Audio('/static/sounds/bell.mp3');
        // audio.play();
    }

    // --- Logic Popup ใหม่ ---
    function showTimeoutPopup() {
        const modal = document.getElementById('timeoutModal');
        modal.style.display = 'flex';

        // ตั้งเวลา 4 วินาที ให้หายไปเอง
        setTimeout(() => {
            closeTimeoutModal();
        }, 4000);
    }

    function closeTimeoutModal(event) {
        // ถ้าคลิกพื้นหลัง หรือถูกเรียกจาก timer
        const modal = document.getElementById('timeoutModal');
        const content = modal.querySelector('.modal-content-timeout');
        
        // ถ้ากดที่ Overlay หรือเป็นการสั่งปิดอัตโนมัติ (event เป็น undefined)
        if (!event || event.target === modal) {
            // ใส่ Animation ขาออก
            content.style.animation = 'fadeOutUp 0.5s forwards';
            modal.style.transition = 'opacity 0.5s';
            modal.style.opacity = '0';
            
            setTimeout(() => {
                modal.style.display = 'none';
                // Reset style สำหรับครั้งหน้า
                content.style.animation = '';
                modal.style.opacity = '1';
            }, 500);
        }
    }
</script>
{% endblock %}