{% extends 'core/base.html' %}
{% load static %}

{% block title %}ตั้งค่าการเรียน - Smart Planner{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" type="text/css" href="{% static 'core/study_settings.css' %}">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
{% endblock %}

{% block content %}
<nav class="navbar">
    <a href="{% url 'set_schedule' %}" class="navbar-brand">
        <i class="fas fa-arrow-left"></i>ตั้งค่าการเรียน
    </a>
</nav>

<div class="container">
    <div class="progress-indicator">
        <div class="progress-step finished">
            <div class="dot">1</div>
            <span>เพิ่มวิชา</span>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step finished">
            <div class="dot">2</div>
            <span>กำหนดเวลาว่าง</span>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step active">
            <div class="dot">3</div>
            <span>สร้างแผน</span>
        </div>
    </div>

    <div class="progress-indicator">
        </div>

    <div class="page-header">
        <h1>ตั้งค่าการเรียนของคุณ</h1>
        <p>ปรับแต่งระยะเวลาการเรียนและการแจ้งเตือนตามที่คุณต้องการ</p>
    </div>

    <form method="post" id="settings-form">
        {% csrf_token %}
        
        <div style="display: none;">
            {{ form.session_duration }}
            {{ form.break_duration }}
            {{ form.notifications_enabled }}
        </div>

        <div class="card">
            <h2>ระยะเวลาการเรียนต่อครั้ง (นาที)</h2>
            <div class="options-grid" id="session-duration-grid">
                <button type="button" class="option-btn" data-value="60">60</button>
                <button type="button" class="option-btn" data-value="90">90</button>
                <button type="button" class="option-btn" data-value="120">120</button>
                <button type="button" class="option-btn" data-value="180">180</button>
                <button type="button" class="option-btn" data-value="240">240</button>
                <input type="number" id="custom-session" class="option-btn1" placeholder="กำหนดเอง (นาที)">
            </div>
        </div>

        <div class="card">
            <h2>ระยะเวลาพักผ่อน (นาที)</h2>
            <div class="options-grid" id="break-duration-grid">
                <button type="button" class="option-btn" data-value="5">5</button>
                <button type="button" class="option-btn" data-value="10">10</button>
                <button type="button" class="option-btn" data-value="15">15</button>
                <button type="button" class="option-btn" data-value="20">20</button>
                <button type="button" class="option-btn" data-value="30">30</button>
                <input type="number" id="custom-break" class="option-btn1" placeholder="กำหนดเอง (นาที)">
            </div>
        </div>

        <div class="card">
            <h2>การแจ้งเตือน</h2>
            <div class="toggle-container">
                <div class="toggle-text">
                    <h3>เปิดการแจ้งเตือน</h3>
                    <p>รับการแจ้งเตือนเมื่อถึงเวลาเรียนและพักผ่อน</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="notification-toggle"> 
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="nav-buttons">
            <a href="{% url 'set_schedule' %}" class="btn btn-back">ย้อนกลับ</a>
            <button type="submit" class="btn btn-save">บันทึกและสร้างตาราง</button>
        </div>

        <div id="loadingModal" class="modal-overlay">
        <div class="modal-content" style="text-align: center; padding: 40px;">
            <i class="fas fa-robot fa-bounce" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 20px;"></i>
            <h3 style="color: #2C3E50; margin-bottom: 10px;">กำลังประมวลผลและสร้างตาราง...</h3>
            <p style="color: #666;">กรุณารอสักครู่ ระบบกำลังวิเคราะห์และบันทึกข้อมูล</p>
        </div>
    </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. จัดการ Session Duration
    const sessionHidden = document.getElementById('id_session_duration');
    const sessionButtons = document.querySelectorAll('#session-duration-grid .option-btn');
    const sessionCustom = document.getElementById('custom-session');

    function updateSelection(buttons, customInput, hiddenInput, value) {
        // Reset classes
        buttons.forEach(btn => btn.classList.remove('active'));
        customInput.classList.remove('active');

        // Check if value matches a button
        let matched = false;
        buttons.forEach(btn => {
            if (btn.dataset.value === value) {
                btn.classList.add('active');
                matched = true;
                customInput.value = ''; // clear custom if preset selected
            }
        });

        // If not matched, it's custom
        if (!matched && value) {
            customInput.classList.add('active');
            customInput.value = value;
        }
        
        // Update hidden form
        hiddenInput.value = value;
    }

    // Event Listeners for Session Buttons
    sessionButtons.forEach(btn => {
        btn.addEventListener('click', () => updateSelection(sessionButtons, sessionCustom, sessionHidden, btn.dataset.value));
    });

    // Event Listener for Session Custom Input
    sessionCustom.addEventListener('input', function() {
        // Clear buttons active state
        sessionButtons.forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        sessionHidden.value = this.value;
    });

    // 2. จัดการ Break Duration (Logic เดียวกัน)
    const breakHidden = document.getElementById('id_break_duration');
    const breakButtons = document.querySelectorAll('#break-duration-grid .option-btn');
    const breakCustom = document.getElementById('custom-break');

    breakButtons.forEach(btn => {
        btn.addEventListener('click', () => updateSelection(breakButtons, breakCustom, breakHidden, btn.dataset.value));
    });

    breakCustom.addEventListener('input', function() {
        breakButtons.forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        breakHidden.value = this.value;
    });

    // 3. จัดการ Notifications
    const notifHidden = document.getElementById('id_notifications_enabled');
    const notifToggle = document.getElementById('notification-toggle');

    if(notifToggle && notifHidden) {
        // Set initial state from Django form
        notifToggle.checked = notifHidden.checked;
        
        notifToggle.addEventListener('change', function() {
            notifHidden.checked = this.checked;
        });
    }

    // Initialize values from DB (ถ้ามีค่าเดิมให้ highlight ปุ่ม)
    if(sessionHidden.value) updateSelection(sessionButtons, sessionCustom, sessionHidden, sessionHidden.value);
    if(breakHidden.value) updateSelection(breakButtons, breakCustom, breakHidden, breakHidden.value);

    const form = document.getElementById('settings-form');
        const loadingModal = document.getElementById('loadingModal');

        if (form) {
            form.addEventListener('submit', function(e) {
                // เมื่อกดปุ่ม submit ให้แสดง Modal ทันที
                // ไม่ต้อง e.preventDefault() เพราะเราต้องการให้ฟอร์มส่งข้อมูลไป Server ตามปกติ
                if (loadingModal) {
                    loadingModal.style.display = 'flex';
                }
            });
        }
});
</script>
{% endblock %}