{% extends 'core/base.html' %}
{% load static %}

{% block title %}กำหนดเวลาว่าง - Smart Planner{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" type="text/css" href="{% static 'core/set_schedule.css' %}">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
{% endblock %}

{% block content %}
<nav class="navbar">
    <a href="{% url 'add_subject' %}" class="navbar-brand">
        <i class="fas fa-arrow-left"></i>กำหนดเวลาว่าง
    </a>
</nav>
<div class="container">
    <div class="progress-indicator">
        <div class="progress-step finished">
            <div class="dot">1</div>
            <span>เพิ่มวิชา</span>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step active">
            <div class="dot">2</div>
            <span>กำหนดเวลาว่าง</span>
        </div>
        <div class="progress-line-sec"></div>
        <div class="progress-step">
            <div class="dot">3</div>
            <span>สร้างแผน</span>
        </div>
    </div>

    <div class="page-header">
        <h1 class="page-title">กำหนดเวลาว่าง</h1>
        <p class="page-subtitle">บอกเราว่าคุณว่างเมื่อไหร่ แล้วเราจะช่วยสร้างแผนการเรียนที่ดีที่สุดให้</p>
    </div>

    <div class="schedule-card">
        <h2>กำหนดเวลาว่าง</h2>
        <!-- {% if messages %}
            {% for message in messages %}
                <div class="alert">{{ message }}</div>
            {% endfor %}
        {% endif %} -->

        <form method="post" id="schedule-form">
            {% csrf_token %}
            
            <div class="main-grid">
                <div class="legend">
                    <h3>ช่วงเวลา</h3>

                    <div class="legend-item" data-slot="morning">
                        <div class="legend-color" style="background: linear-gradient(135deg, #ff9800, #f57c00);"></div>
                        <div>
                            <div class="legend-text">เช้า</div>
                            <div class="legend-time">(06:00-12:00)</div>
                        </div>
                    </div>

                    <div class="legend-item" data-slot="afternoon">
                        <div class="legend-color" style="background: linear-gradient(135deg, #f44336, #d32f2f);"></div>
                        <div>
                            <div class="legend-text">บ่าย</div>
                            <div class="legend-time">(13:00-18:00)</div>
                        </div>
                    </div>

                    <div class="legend-item" data-slot="evening">
                        <div class="legend-color" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2);"></div>
                        <div>
                            <div class="legend-text">เย็น</div>
                            <div class="legend-time">(18:00-22:00)</div>
                        </div>
                    </div>

                    <div class="legend-item" data-slot="night">
                        <div class="legend-color" style="background: linear-gradient(135deg, #2196f3, #1976d2);"></div>
                        <div>
                            <div class="legend-text">กลางคืน</div>
                            <div class="legend-time">(22:00-02:00)</div>
                        </div>
                    </div>
                </div>
                
                <div class="schedule-grid">
                    {% for day_num, day_name in days.items %}
                        <div class="day-header">{{ day_name }}</div>
                    {% endfor %}

                    {% for slot in time_slots %}
                        {% for day_num, day_name in days.items %}

                            {% with day_str=day_num|stringformat:"s" %}
                            {% with slot_id=day_str|add:"_"|add:slot.id %}

                            <label class="time-slot {{ slot.class }} {% if slot_id in user_selections %}selected{% endif %}"
                                   title="{{ day_name }} - {{ slot.label }}">

                                <input type="checkbox" 
                                       name="slot_{{ day_num }}_{{ slot.id }}" 
                                       {% if slot_id in user_selections %}checked{% endif %}>
                            </label>
                        
                            {% endwith %}
                            {% endwith %}
                        
                        {% endfor %}
                    {% endfor %}
                </div>
            </div>

        </form>
    </div>
    <div class="nav-buttons">
        <a href="{% url 'add_subject' %}" class="btn btn-back">ย้อนกลับ</a>
        <button type="submit" form="schedule-form" class="btn btn-next">ถัดไป</button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('schedule-form');
        const nextBtn = document.querySelector('.btn-next');
        const scheduleGrid = document.querySelector('.schedule-grid');

        let isMouseDown = false;
        let dragAction = null;

        function updateSlotState(slot, shouldBeSelected) {
            const checkbox = slot.querySelector('input[type="checkbox"]');
            if (shouldBeSelected) {
                slot.classList.add('selected');
            } else {
                slot.classList.remove('selected');
            }
            if (checkbox) checkbox.checked = shouldBeSelected;
        }

        function updateNextButtonState() {
            const checkedSlots = form.querySelectorAll('input[type="checkbox"]:checked');
            // Uncomment บรรทัดล่างถ้าต้องการบังคับให้เลือกอย่างน้อย 1 ช่อง
            // nextBtn.disabled = checkedSlots.length === 0;
        }

        function initializeLegendClick() {
            document.querySelectorAll('.legend-item').forEach(item => {
                item.style.cursor = 'pointer';
                item.addEventListener('click', function() {
                    const slotType = this.dataset.slot;
                    const targetSlots = document.querySelectorAll(`.time-slot.${slotType}`);
                    
                    // เช็คว่าในแถวนั้นถูกเลือกครบหรือยัง
                    const allSelected = Array.from(targetSlots).every(slot => slot.classList.contains('selected'));
                    const shouldSelect = !allSelected; // ถ้าครบแล้วให้ยกเลิก, ถ้ายังให้เลือกทั้งหมด

                    targetSlots.forEach(slot => updateSlotState(slot, shouldSelect));
                    updateNextButtonState();
                });
            });
        }

        function initializeScheduleGrid() {
            scheduleGrid.addEventListener('selectstart', e => e.preventDefault());

            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.setAttribute('tabindex', '0');
                slot.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    isMouseDown = true;
                    const isCurrentlySelected = this.classList.contains('selected');
                    dragAction = isCurrentlySelected ? 'deselect' : 'select';

                    updateSlotState(this, !isCurrentlySelected);
                });

                slot.addEventListener('mouseover', function() {
                    if (isMouseDown) { 
                        const shouldSelect = (dragAction === 'select');
                        updateSlotState(this, shouldSelect);
                    }
                });

                slot.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        updateSlotState(this, !this.classList.contains('selected'));
                        updateNextButtonState();
                    }
                });
            });

            window.addEventListener('mouseup', function() {
                if (isMouseDown) {
                    isMouseDown = false;
                    dragAction = null;
                    updateNextButtonState();
                }
            });
        }

        initializeScheduleGrid();
        initializeLegendClick();
        form.addEventListener('change', updateNextButtonState);
        updateNextButtonState();
    });
</script>
{% endblock %}